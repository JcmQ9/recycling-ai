<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>SmartLocate - Recycling AI</title>
        <link rel="stylesheet" href="styles.css">
</head>

<body>
  <div class="wrap">
    <div class="header">
      <div class="brand">
        <h1>SmartLocate</h1>
        <p>Type an item and Gemini will classify the waste and give disposal instructions. Your searches are saved in Firebase for history & insights.</p>
      </div>
      <div class="pill">Google AI (Gemini) + Firebase</div>
    </div>

    <!-- LEFT: Classifier -->
    <div class="card">
      <div class="top">
        <h2>AI Waste Classifier</h2>
        <p>Example: plastic bottle, pizza box, aluminium can, styrofoam.</p>
      </div>
      <div class="body">
        <div class="row">
          <input id="itemInput" placeholder="Enter an item (e.g., plastic bottle)" />
          <button id="btn" onclick="classifyItem()">Classify</button>
        </div>

        <div class="hint" id="quick">
          <span data-v="plastic bottle">plastic bottle</span>
          <span data-v="pizza box">pizza box</span>
          <span data-v="aluminium can">aluminium can</span>
          <span data-v="styrofoam">styrofoam</span>
          <span data-v="glass bottle">glass bottle</span>
        </div>Google AI Technology

        <div class="result" id="result">
          <div class="toast">Waiting for input…</div>
        </div>

        <div class="small" id="status"></div>
      </div>
    </div>

    <!-- RIGHT: History -->
    <div class="card">
      <div class="top">
        <h2>Recent Searches</h2>
        <p>Last 5 items saved from Firebase Realtime Database.</p>
      </div>
      <div class="body">
        <ul id="historyList"></ul>
        <div class="toast" id="historyEmpty">No history yet. Try classifying an item.</div>
      </div>
    </div>
  </div>

  <script type="module">
    // ---------- Firebase (Realtime Database) ----------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getDatabase, ref, push, set, onValue, query, limitToLast } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

    // Firebase config
    const firebaseConfig = {
        apiKey: "YOUR_OWN",
        authDomain: "YOUR_OWN",
        databaseURL: "YOUR_OWN",
        projectId: "YOUR_OWN",
        storageBucket: "YOUR_OWN",
        messagingSenderId: "YOUR_OWN",
        appId: "YOUR_OWN"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // ---------- Gemini ----------
    //  Gemini API key
    const API_KEY = "YOUR_OWN";

    // UI helpers
    const btn = document.getElementById("btn");
    const resultEl = document.getElementById("result");
    const statusEl = document.getElementById("status");
    const inputEl = document.getElementById("itemInput");

    // Allow pressing Enter to trigger classify
    inputEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !btn.disabled) {
        classifyItem();
        }
    });

    function extractField(text, label) {
      return (text.match(new RegExp(`${label}:\\s*(.*)`, "i"))?.[1] || "").trim();
    }

    function renderResult({ 
        binType, 
        reason, 
        instructions, 
        fullOutput
    }) 
    {
        const isNonRecycle = /non[-\s]?recyclable/i.test(binType || "");
        const tagClass = isNonRecycle ? "bad" : "good";
        const tagText = binType 
            ? (isNonRecycle ? "Non-recyclable" : `♻️ ${binType}`)
            : "Unknown";

      resultEl.innerHTML = `
        <div class="grid">
          <div class="field">
            <div class="label">Bin Type</div>
            <div class="value"><span class="tag ${tagClass}">${tagText}</span></div>
          </div>
          <div class="field">
            <div class="label">Reason</div>
            <div class="value">${reason || "-"}</div>
          </div>
          <div class="field">
            <div class="label">Instructions</div>
            <div class="value">${instructions || "-"}</div>
          </div>
        </div>
      `;
    }

    async function classifyItem() {
      const item = inputEl.value.trim();
      if (!item) {
        resultEl.innerHTML = `<div class="toast">Please type something first.</div>`;
        return;
      }

      btn.disabled = true;
      statusEl.textContent = "";
      resultEl.innerHTML = `<div class="toast">⏳ Analyzing with Gemini AI...</div>`;

      try {
        const response = await fetch(
          "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent",
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "x-goog-api-key": API_KEY
            },
            body: JSON.stringify({
              contents: [{
                parts: [{
                  text: `You are a recycling assistant.
Classify the item into one of: Plastic, Paper, Metal, Glass, Non-recyclable.
Return in this exact format:

BinType: ...
Reason: ...
Instructions: ...

Item: ${item}`
                }]
              }]
            })
          }
        );

        if (!response.ok) {
          const err = await response.text();
          resultEl.innerHTML = `<div class="toast" style="color:var(--danger)">Error: ${err}</div>`;
          return;
        }

        const data = await response.json();
        const output = data?.candidates?.[0]?.content?.parts?.[0]?.text || "";

        const binType = extractField(output, "BinType");
        const reason = extractField(output, "Reason");
        const instructions = extractField(output, "Instructions");

        renderResult({ binType, reason, instructions, fullOutput: output });

        // ✅ Save to Firebase
        const newRef = push(ref(db, "history"));
        await set(newRef, {
          item,
          binType,
          reason,
          instructions,
          fullOutput: output,
          timestamp: Date.now()
        });

        statusEl.textContent = "Saved to Firebase ✅";

      } catch (error) {
        resultEl.innerHTML = `<div class="toast" style="color:var(--danger)">Request failed: ${error.message}</div>`;
      } finally {
        btn.disabled = false;
      }
    }

    // expose for onclick
    window.classifyItem = classifyItem;

    // Quick chips
    document.getElementById("quick").addEventListener("click", (e) => {
      const v = e.target?.dataset?.v;
      if (!v) return;
      inputEl.value = v;
      inputEl.focus();
    });

    // ---------- Read last 5 from Firebase ----------
    const historyList = document.getElementById("historyList");
    const empty = document.getElementById("historyEmpty");
    const historyQuery = query(ref(db, "history"), limitToLast(5));

    onValue(historyQuery, (snapshot) => {
      historyList.innerHTML = "";
      const data = snapshot.val();

      if (!data) {
        empty.style.display = "block";
        return;
      }
      empty.style.display = "none";

      const entries = Object.entries(data)
        .map(([id, v]) => ({ id, ...v }))
        .sort((a,b) => (b.timestamp || 0) - (a.timestamp || 0)); // newest first

      for (const entry of entries) {
        const li = document.createElement("li");
        const time = entry.timestamp ? new Date(entry.timestamp).toLocaleString() : "-";
        li.innerHTML = `
          <div class="liTop">
            <div class="liItem">${entry.item || "-"}</div>
            <div class="tag ${/non[-\s]?recyclable/i.test(entry.binType||"") ? "bad" : "good"}">${entry.binType || "Unknown"}</div>
          </div>
          <div class="liMeta">${time}</div>
        `;
        historyList.appendChild(li);
      }
    });
  </script>
</body>
</html>