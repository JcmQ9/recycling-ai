<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>SmartLocate - Recycling AI</title>
        <link rel="stylesheet" href="styles.css">
</head>

<body>
  <div class="wrap">
    <div class="header">
      <div class="brand">
        <h1>SmartLocate</h1>
        <p>Type an item and Gemini will classify the waste and give disposal instructions. Your searches are saved in Firebase for history & insights.</p>
      </div>
      <div class="pill">Google AI (Gemini) + Firebase</div>
    </div>

    <!-- LEFT: Classifier -->
    <div class="card">
      <div class="top">
        <h2>AI Waste Classifier</h2>
        <p>Example: plastic bottle, pizza box, aluminium can, styrofoam.</p>
      </div>
      <div class="body">
        <div class="row">
          <input id="itemInput" placeholder="Enter an item (e.g., plastic bottle)" />
          <button id="btn" onclick="classifyItem()">Classify</button>
        </div>

        <div class="hint" id="quick">
          <span data-v="plastic bottle">plastic bottle</span>
          <span data-v="pizza box">pizza box</span>
          <span data-v="aluminium can">aluminium can</span>
          <span data-v="styrofoam">styrofoam</span>
          <span data-v="glass bottle">glass bottle</span>
        </div>Google AI Technology

        <div class="result" id="result">
          <div class="toast">Waiting for input…</div>
        </div>

        <div class="small" id="status"></div>
      </div>
    </div>

    <!-- RIGHT: History -->
    <div class="card">
      <div class="top">
        <h2>Recent Searches</h2>
        <p>Last 5 items saved from Firebase Realtime Database.</p>
      </div>
      <div class="body">
        <ul id="historyList"></ul>
        <div class="toast" id="historyEmpty">No history yet. Try classifying an item.</div>
      </div>
    </div>
  </div>

  <script type="module">
    // ---------- Firebase (Realtime Database) ----------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getDatabase, ref, push, set, onValue, query, limitToLast } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

    // Firebase config
   const firebaseConfig = {
          apiKey: "AIzaSyAOS7qzd9yrHL1Wszd8h_Z8PNzF_0iNnDQ",
          authDomain: "smartlocate-2baed.firebaseapp.com",
          databaseURL: "https://smartlocate-2baed-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "smartlocate-2baed",
          storageBucket: "smartlocate-2baed.firebasestorage.app",
          messagingSenderId: "493815075085",
          appId: "1:493815075085:web:b5cfaabfa1e8bcf314a044"
   };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // ---------- Gemini ----------
    //  Gemini API key
    const API_KEY = "AIzaSyCtDzN-TIC46VawQN5GYzmhKxzmlMiTmaY";

    // UI helpers
    const btn = document.getElementById("btn");
    const resultEl = document.getElementById("result");
    const statusEl = document.getElementById("status");
    const inputEl = document.getElementById("itemInput");

    // Allow pressing Enter to trigger classify
    inputEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !btn.disabled) {
        classifyItem();
        }
    });

    function extractField(text, label) {
      return (text.match(new RegExp(`${label}:\\s*(.*)`, "i"))?.[1] || "").trim();
    }

    function renderResult({ 
        binType, 
        reason, 
        instructions, 
        fullOutput
    }) 
    {
        const isNonRecycle = /non[-\s]?recyclable/i.test(binType || "");
        const tagClass = isNonRecycle ? "bad" : "good";
        const tagText = binType 
            ? (isNonRecycle ? "Non-recyclable" : `♻️ ${binType}`)
            : "Unknown";

      resultEl.innerHTML = `
        <div class="grid">
          <div class="field">
            <div class="label">Bin Type</div>
            <div class="value"><span class="tag ${tagClass}">${tagText}</span></div>
          </div>
          <div class="field">
            <div class="label">Reason</div>
            <div class="value">${reason || "-"}</div>
          </div>
          <div class="field">
            <div class="label">Instructions</div>
            <div class="value">${instructions || "-"}</div>
          </div>
        </div>
      `;
    }

    async function classifyItem() {
      const item = inputEl.value.trim();
      if (!item) {
        resultEl.innerHTML = `<div class="toast">Please type something first.</div>`;
        return;
      }

      btn.disabled = true;
      statusEl.textContent = "";
      resultEl.innerHTML = `<div class="toast">⏳ Analyzing with Gemini AI...</div>`;

      try {
        const response = await fetch(
          "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent",
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "x-goog-api-key": API_KEY
            },
            body: JSON.stringify({
              contents: [{
                parts: [{
                  text: `You are a recycling assistant.
Classify the item into one of: Plastic, Paper, Metal, Glass, Non-recyclable.
Return in this exact format:

BinType: ...
Reason: ...
Instructions: ...

Item: ${item}`
                }]
              }]
            })
          }
        );

        if (!response.ok) {
          const err = await response.text();
          resultEl.innerHTML = `<div class="toast" style="color:var(--danger)">Error: ${err}</div>`;
          return;
        }

        const data = await response.json();
        const output = data?.candidates?.[0]?.content?.parts?.[0]?.text || "";

        const binType = extractField(output, "BinType");
        const reason = extractField(output, "Reason");
        const instructions = extractField(output, "Instructions");

        renderResult({ binType, reason, instructions, fullOutput: output });

        // Save to Firebase
        const newRef = push(ref(db, "history"));
        await set(newRef, {
          item,
          binType,
          reason,
          instructions,
          fullOutput: output,
          timestamp: Date.now()
        });

        statusEl.textContent = "Saved to Firebase";

      } catch (error) {
        resultEl.innerHTML = `<div class="toast" style="color:var(--danger)">Request failed: ${error.message}</div>`;
      } finally {
        btn.disabled = false;
      }
    }

    // expose for onclick
    window.classifyItem = classifyItem;

    // Quick chips
    document.getElementById("quick").addEventListener("click", (e) => {
      const v = e.target?.dataset?.v;
      if (!v) return;
      inputEl.value = v;
      inputEl.focus();
    });

    // ---------- Read last 5 from Firebase ----------
    const historyList = document.getElementById("historyList");
    const empty = document.getElementById("historyEmpty");
    const historyQuery = query(ref(db, "history"), limitToLast(5));

    onValue(historyQuery, (snapshot) => {
      historyList.innerHTML = "";
      const data = snapshot.val();

      if (!data) {
        empty.style.display = "block";
        return;
      }
      empty.style.display = "none";

      const entries = Object.entries(data)
        .map(([id, v]) => ({ id, ...v }))
        .sort((a,b) => (b.timestamp || 0) - (a.timestamp || 0)); // newest first

      for (const entry of entries) {
  const li = document.createElement("li");

  const time = entry.timestamp ? new Date(entry.timestamp).toLocaleString() : "-";

  // Store details so that user do not need to input Gemini for recent search
  li.dataset.item = entry.item || "-";
  li.dataset.bin = entry.binType || "Unknown";
  li.dataset.reason = entry.reason || "-";
  li.dataset.instructions = entry.instructions || "-";
  li.dataset.time = time;

  li.innerHTML = `
    <div class="liTop">
      <div class="liItem">${entry.item || "-"}</div>
      <div class="tag ${/non[-\s]?recyclable/i.test(entry.binType||"") ? "bad" : "good"}">
        ${entry.binType || "Unknown"}
      </div>
    </div>
    <div class="liMeta">${time}</div>
  `;

  historyList.appendChild(li);
}
    });

// ----- Click -> Modal details -----
const modal = document.getElementById("detailsModal");
const mClose = document.getElementById("mClose");
const mItem = document.getElementById("mItem");
const mMeta = document.getElementById("mMeta");
const mBin = document.getElementById("mBin");
const mReason = document.getElementById("mReason");
const mInstr = document.getElementById("mInstr");

function openModalFromLi(li) {
  mItem.textContent = li.dataset.item || "-";
  mMeta.textContent = li.dataset.time || "-";
  mBin.textContent = li.dataset.bin || "Unknown";
  mReason.textContent = li.dataset.reason || "-";
  mInstr.textContent = li.dataset.instructions || "-";
  modal.classList.remove("hidden");
}

function closeModal() {
  modal.classList.add("hidden");
}

mClose.addEventListener("click", closeModal);
modal.addEventListener("click", (e) => {
  if (e.target === modal) closeModal(); // click backdrop
});
document.addEventListener("keydown", (e) => {
  if (e.key === "Escape") closeModal();
});

// Delegate click handler for any future <li>
historyList.addEventListener("click", (e) => {
  const li = e.target.closest("li");
  if (!li) return;
  openModalFromLi(li);
});

// ----- Hover -> Tooltip (desktop) -----
const hoverTip = document.getElementById("hoverTip");
let hoverEnabled = window.matchMedia("(hover:hover)").matches;

function showTip(li, x, y) {
  const item = li.dataset.item || "-";
  const reason = li.dataset.reason || "-";
  const instr = li.dataset.instructions || "-";

  hoverTip.innerHTML = `
    <div class="t">${item}</div>
    <div class="v"><span class="k">Reason:</span> ${reason}</div>
    <div class="v"><span class="k">Instructions:</span> ${instr}</div>
  `;

  hoverTip.classList.remove("hidden");

  // Position near cursor with simple bounds
  const pad = 12;
  const rect = hoverTip.getBoundingClientRect();
  let left = x + pad;
  let top = y + pad;

  if (left + rect.width > window.innerWidth - 8) left = window.innerWidth - rect.width - 8;
  if (top + rect.height > window.innerHeight - 8) top = window.innerHeight - rect.height - 8;

  hoverTip.style.left = left + "px";
  hoverTip.style.top = top + "px";
}

function hideTip() {
  hoverTip.classList.add("hidden");
}

historyList.addEventListener("mousemove", (e) => {
  if (!hoverEnabled) return;
  const li = e.target.closest("li");
  if (!li) return hideTip();
  showTip(li, e.clientX, e.clientY);
});

historyList.addEventListener("mouseleave", () => {
  if (!hoverEnabled) return;
  hideTip();
});
          
  </script>
<!-- Details Modal -->
<div id="detailsModal" class="modal hidden" role="dialog" aria-modal="true">
  <div class="modalCard">
    <div class="modalHeader">
      <div>
        <div class="modalTitle" id="mItem">-</div>
        <div class="modalSub" id="mMeta">-</div>
      </div>
      <button class="modalClose" id="mClose" aria-label="Close">✕</button>
    </div>

    <div class="modalSection">
      <div class="label">Bin Type</div>
      <div class="value" id="mBin">-</div>
    </div>

    <div class="modalSection">
      <div class="label">Reason</div>
      <div class="value" id="mReason">-</div>
    </div>

    <div class="modalSection">
      <div class="label">Instructions</div>
      <div class="value" id="mInstr">-</div>
    </div>
  </div>
</div>

// Hover tooltip (desktop) 
<div id="hoverTip" class="hoverTip hidden"></div>
</body>

</html>


